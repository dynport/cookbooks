Hostname    "<%= `hostname`.strip %>"

LoadPlugin syslog
<Plugin "syslog">
  <% if log_level = node.collectd[:log_level] %>
  LogLevel "#{log_level}"
  <% end %>
</Plugin>

LoadPlugin cpu
LoadPlugin interface
LoadPlugin load
LoadPlugin memory
LoadPlugin swap
<Plugin "swap">
  ReportByDevice false
</Plugin>

<% if @processes %>
LoadPlugin processes
<Plugin processes>
  <% @processes.each do |process_name| %>
  Process <%= process_name.to_s.inspect %>
  <% end %>
</Plugin>
<% end %>

<% if @mount_points %>
LoadPlugin df
<Plugin df>
  <% @mount_points.each do |mount_point| %>
  MountPoint <%= mount_point.to_s.inspect %>
  <% end %>
</Plugin>
<% end %>

<% if @memcached_address && @memcached_port %>
LoadPlugin memcached
<Plugin memcached>
  Host <%= @memcached_address.to_s.inspect %>
  Port <%= @memcached_port.to_s.inspect %>
</Plugin>
<% end %>

<% if @redis_nodes %>
LoadPlugin redis
<Plugin redis>
<% @redis_nodes.each do |node_name, config| %>
  <Node <%= node_name %>>
    Host <%= config.fetch("address").to_s.inspect %>
    Port <%= config.fetch("port").to_s.inspect %>
    Timeout 2000
  </Node>
</Plugin>
<% end %>
<% end %>

<% if node.collectd[:graphite_address] && node.collectd[:graphite_port] %>
LoadPlugin write_graphite
<Plugin write_graphite>
  <Carbon>
    Host <%= node.collectd[:graphite_address].to_s.inspect %>
    Port <%= node.collectd[:graphite_port].to_s.inspect %>
    Prefix "collectd."
    Postfix ""
    StoreRates false
    AlwaysAppendDS false
    EscapeCharacter "-"
  </Carbon>
</Plugin>
<% end %>

#LoadPlugin exec
#<Plugin exec>
#	Exec "user:group" "/path/to/exec"
#	NotificationExec "user:group" "/path/to/exec"
#</Plugin>

<% if @nginx_url %>
LoadPlugin nginx
<Plugin nginx>
	URL "<%= @nginx_url %>"
</Plugin>
<% end %>

<% if node.collectd[:mysql] %>
LoadPlugin mysql
<Plugin "mysql">
  <Database "information_schema">
    Host "localhost"
    User "root"
    Port 3306
    <% if node.collectd[:mysql_slave] %>
    SlaveStats true
    SlaveNotifications true
    <% end %>
  </Database>
</Plugin>
<% end %>

<% if node.collectd[:mysql_slave] %>
LoadPlugin dbi
<Plugin dbi>
  <Query "seconds_behind_master">
    Statement "SHOW SLAVE STATUS"
    <Result>
      Type "gauge"
      InstancePrefix "seconds_behind_master"
      ValuesFrom "Seconds_Behind_Master"
    </Result>
  </Query>
  <Database "customers_db">
    Driver "mysql"
    DriverOption "host" "localhost"
    DriverOption "username" "collectd"
    DriverOption "dbname" "information_schema"
    Query "seconds_behind_master"
  </Database>
</Plugin>
<% end %>
