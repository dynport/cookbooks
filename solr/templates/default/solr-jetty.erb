#!/bin/bash

PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
USER=solr
PIDFILE=/var/run/<%= ["solr", @role].compact.join("_") %>.pid

JAVA_HEAP_SIZE="<%= @node.solr.java_heap_size %>"
JAVA_NEW_SIZE="<%= @node.solr.java_new_size %>"
JAVA_SURVIVOR_RATIO="<%= @node.solr.java_survivor_ratio %>"

# Garbage collections - use concurrent low pause collectors
JAVA_OPTS="-XX:+UseConcMarkSweepGC -XX:+UseParNewGC"

# Memory settings: Heap size
JAVA_OPTS="$JAVA_OPTS -Xmx$JAVA_HEAP_SIZE -Xms$JAVA_HEAP_SIZE"

# Memory settings: Young generation
JAVA_OPTS="$JAVA_OPTS -XX:NewSize=$JAVA_NEW_SIZE -XX:SurvivorRatio=$JAVA_SURVIVOR_RATIO"

# enable or disable newrelic agent
# NEWRELIC_OPTS="-javaagent:/home/solr/tomcat/newrelic/newrelic.jar"

#  $JAVA_OPTS $NEWRELIC_OPTS
START_PREFIX="start-stop-daemon -c $USER -m --pidfile $PIDFILE --start --chdir /opt/apache-solr/example --exec /usr/bin/java -- $JAVA_OPTS"

SOLR_HOME="<%= @solr_home %>"
SOLR_PORT="<%= @solr_port %>"
SOLR_OPTS="-Dsolr.solr.home=$SOLR_HOME -Djetty.port=$SOLR_PORT"
SOLR_MASTER_URL="<%= @node.solr.master_url %>"

set -e

# Parse command line parameters.
case $1 in
    start)
        echo "starting SOLR"
        $($START_PREFIX $SOLR_OPTS <%= @master_slave_options %> -jar start.jar 2>&1 | logger -t solr &)
        ;;
    stop)
        echo "stopping SOLR"
        start-stop-daemon --pidfile $PIDFILE --stop
        ;;
    restart)
  $0 stop
  sleep 10s
  $0 start
        ;;
    *)
        # Print help
        echo "Usage: $0 {start|start_master|start_slave|    stop|restart}" 1>&2
        exit 1
        ;;
esac

exit 0
